<%- include('../partials/head') %>
<%- include('../partials/navbar') %>
<main class="page tests-result-page" data-aos="fade-up" data-score="<%= result && typeof result.score === 'number' ? result.score : 0 %>">
  <section class="section">
    <div class="section-inner">
      <% if (!test) { %>
        <h1 class="section-title">Test topilmadi</h1>
        <p class="tests-empty">Bu test topilmadi yoki oâ€˜chirilgan.</p>
      <% } else { %>
        <h1 class="section-title"><%= test.title %> â€” Natija</h1>

        <div class="tests-layout">
          <div class="card">
            <div class="test-header">
              <div>
                <div class="test-title"><%= test.title %></div>
                <div class="test-meta">
                  <% if (typeof test.totalQuestions !== 'undefined' && test.totalQuestions !== null) { %>
                    <span><%= test.totalQuestions %> ta savol
                      <% if (typeof test.closedCount !== 'undefined' && test.closedCount !== null) { %>
                        Â· <%= test.closedCount %> ta yopiq (A/B/C/D) savol
                      <% } %>
                    </span>
                  <% } %>
                </div>
              </div>
            </div>

            <% var scoreVal = result && typeof result.score === 'number' ? result.score : 0; %>
            <div class="test-result-block">
              <% if (!result) { %>
                <p class="tests-empty">Bu test boâ€˜yicha hali natija topilmadi.</p>
              <% } else { %>
                <div class="result-summary">
                  <div class="result-score-main"><%= result.score %>%</div>
                  <div class="result-score-label">Sizning natijangiz</div>
                  <div class="result-score-meta">
                    Yakunlangan sana: <%= new Date(result.createdAt).toLocaleString('uz-UZ') %>
                  </div>
                </div>

                <% if (passed) { %>
                  <div class="test-video-wrapper">
                    <h3>Tabriklaymiz! Siz testni muvaffaqiyatli topshirdingiz.</h3>
                    <% if (test.videoLink) { 
                      const rawVideo = test.videoLink || '';
                      const noQueryVideo = rawVideo.split('?')[0];
                      const videoSrc = noQueryVideo.replace('/view', '/preview');
                    %>
                      <p>Quyidagi videoni tomosha qilib, mavzuni yanada mustahkamlab oling.</p>
                      <div class="test-video-embed">
                        <iframe src="<%= videoSrc %>" frameborder="0" allowfullscreen></iframe>
                      </div>
                    <% } else { %>
                      <p>Bu test uchun hozircha video biriktirilmagan.</p>
                    <% } %>
                  </div>
                <% } else { %>
                  <div class="test-fail-block">
                    <h3>Bu safar yetarli boâ€˜lmadi ðŸ˜…</h3>
                    <p>Yana bir bor urinib koâ€˜ring yoki boshqa testni tanlang. Muntazam mashq qilsangiz, albatta natija boâ€˜ladi.</p>
                  </div>
                <% } %>
              <% } %>

              <div class="result-actions">
                <a href="/tests/<%= test._id %>" class="btn-outline">Testni qayta yechish</a>
                <a href="/tests" class="btn-primary">Boshqa testlarni koâ€˜rish</a>
              </div>
            </div>
          </div>
        </div>
      <% } %>
    </div>
  </section>
</main>

<% if (result && typeof result.score === 'number' && result.score >= 80) { %>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script>
    (function () {
      if (typeof confetti !== 'function') return;

      var duration = 6000; // 6 soniya davomida zar
      var animationEnd = Date.now() + duration;
      var defaults = { startVelocity: 30, spread: 360, ticks: 40, zIndex: 9999 };

      var pageEl = document.querySelector('.tests-result-page');
      var scoreVal = 0;
      if (pageEl) {
        var rawScore = pageEl.getAttribute('data-score');
        if (rawScore) {
          var parsed = parseInt(rawScore, 10);
          if (!isNaN(parsed)) {
            scoreVal = parsed;
          }
        }
      }

      // 100% bo'lsa qo'shimcha kuchli portlash (salyut)
      if (scoreVal === 100) {
        setTimeout(function () {
          confetti(Object.assign({}, defaults, {
            particleCount: 220,
            startVelocity: 70,
            spread: 360,
            origin: { x: 0.5, y: 0.35 },
            scalar: 1.8
          }));
        }, 400);
      }

      function randomInRange(min, max) {
        return Math.random() * (max - min) + min;
      }

      var interval = setInterval(function () {
        var timeLeft = animationEnd - Date.now();
        if (timeLeft <= 0) {
          return clearInterval(interval);
        }

        var particleCount = 40 * (timeLeft / duration);

        confetti(Object.assign({}, defaults, {
          particleCount: particleCount,
          origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 }
        }));

        confetti(Object.assign({}, defaults, {
          particleCount: particleCount,
          origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 }
        }));
      }, 250);
    })();
  </script>
<% } %>

<%- include('../partials/footer') %>
