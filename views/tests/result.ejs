<%- include('../partials/head') %>
<%- include('../partials/navbar') %>
<main class="page" data-aos="fade-up">
  <section class="section">
    <div class="section-inner">
      <% if (!test) { %>
        <h1 class="section-title">Test topilmadi</h1>
        <p class="tests-empty">Bu test topilmadi yoki oâ€˜chirilgan.</p>
      <% } else { %>
        <h1 class="section-title"><%= test.title %> â€” Natija</h1>

        <div class="tests-layout">
          <div class="card">
            <div class="test-header">
              <div>
                <div class="test-title"><%= test.title %></div>
                <div class="test-meta">
                  <% if (typeof test.totalQuestions !== 'undefined' && test.totalQuestions !== null) { %>
                    <span><%= test.totalQuestions %> ta savol
                      <% if (typeof test.closedCount !== 'undefined' && test.closedCount !== null) { %>
                        Â· <%= test.closedCount %> ta yopiq (A/B/C/D) savol
                      <% } %>
                    </span>
                  <% } %>
                </div>
              </div>
            </div>

            <% var scoreVal = result && typeof result.score === 'number' ? result.score : 0; %>
            <div class="test-result-block">
              <% if (!result) { %>
                <p class="tests-empty">Bu test boâ€˜yicha hali natija topilmadi.</p>
              <% } else { %>
                <div class="result-summary">
                  <div class="result-score-main"><%= result.score %>%</div>
                  <div class="result-score-label">Sizning natijangiz</div>
                  <div class="result-score-meta">
                    Yakunlangan sana: <%= new Date(result.createdAt).toLocaleString('uz-UZ') %>
                  </div>
                </div>

                <% if (scoreVal >= 80) { %>
                  <div class="result-confetti result-confetti-left"></div>
                  <div class="result-confetti result-confetti-right"></div>
                <% } %>

                <% if (scoreVal === 100) { %>
                  <div class="result-fireworks" id="resultFireworks">
                    <canvas id="resultFwCanvas"></canvas>
                  </div>
                <% } %>

                <% if (passed) { %>
                  <div class="test-video-wrapper">
                    <h3>Tabriklaymiz! Siz testni muvaffaqiyatli topshirdingiz.</h3>
                    <% if (test.videoLink) { 
                      const rawVideo = test.videoLink || '';
                      const noQueryVideo = rawVideo.split('?')[0];
                      const videoSrc = noQueryVideo.replace('/view', '/preview');
                    %>
                      <p>Quyidagi videoni tomosha qilib, mavzuni yanada mustahkamlab oling.</p>
                      <div class="test-video-embed">
                        <iframe src="<%= videoSrc %>" frameborder="0" allowfullscreen></iframe>
                      </div>
                    <% } else { %>
                      <p>Bu test uchun hozircha video biriktirilmagan.</p>
                    <% } %>
                  </div>
                <% } else { %>
                  <div class="test-fail-block">
                    <h3>Bu safar yetarli boâ€˜lmadi ðŸ˜…</h3>
                    <p>Yana bir bor urinib koâ€˜ring yoki boshqa testni tanlang. Muntazam mashq qilsangiz, albatta natija boâ€˜ladi.</p>
                  </div>
                <% } %>
              <% } %>

              <div class="result-actions">
                <a href="/tests/<%= test._id %>" class="btn-outline">Testni qayta yechish</a>
                <a href="/tests" class="btn-primary">Boshqa testlarni koâ€˜rish</a>
              </div>
            </div>
          </div>
        </div>
      <% } %>
    </div>
  </section>
</main>

<script>
  (function () {
    var canvas = document.getElementById('resultFwCanvas');
    if (!canvas) return;

    var ctx = canvas.getContext('2d');
    var container = document.getElementById('resultFireworks');
    if (!ctx || !container) return;

    function resize() {
      var rect = container.getBoundingClientRect();
      canvas.width = rect.width;
      canvas.height = rect.height;
    }

    resize();
    window.addEventListener('resize', resize);

    function Particle(x, y, color) {
      this.x = x;
      this.y = y;
      this.speed = Math.random() * 3 + 1;
      this.angle = Math.random() * Math.PI * 2;
      this.alpha = 1;
      this.decay = Math.random() * 0.02 + 0.01;
      this.color = color;
    }
    Particle.prototype.update = function () {
      this.x += Math.cos(this.angle) * this.speed;
      this.y += Math.sin(this.angle) * this.speed + 0.2;
      this.alpha -= this.decay;
    };
    Particle.prototype.draw = function () {
      ctx.globalAlpha = this.alpha;
      ctx.fillStyle = this.color;
      ctx.beginPath();
      ctx.arc(this.x, this.y, 3, 0, Math.PI * 2);
      ctx.fill();
    };

    var particles = [];

    function launchFirework() {
      var w = canvas.width;
      var h = canvas.height;
      if (!w || !h) return;
      var x = Math.random() * w * 0.8 + w * 0.1;
      var y = Math.random() * h * 0.4 + h * 0.1;
      var color = 'hsl(' + (Math.random() * 360) + ', 100%, 60%)';

      for (var i = 0; i < 80; i++) {
        particles.push(new Particle(x, y, color));
      }
    }

    var intervalId = setInterval(launchFirework, 220);

    setTimeout(function () {
      clearInterval(intervalId);
    }, 4000);

    function animate() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      for (var i = particles.length - 1; i >= 0; i--) {
        var p = particles[i];
        p.update();
        p.draw();
        if (p.alpha <= 0) {
          particles.splice(i, 1);
        }
      }

      requestAnimationFrame(animate);
    }

    animate();
  })();
</script>

<%- include('../partials/footer') %>
