<%- include('../partials/head') %>
<%- include('../partials/navbar') %>

<main class="page" data-aos="fade-up">
  <section class="section">
    <div class="section-inner">
      <h1 class="section-title">Testni tahrirlash</h1>

      <% if (typeof testError !== 'undefined' && testError) { %>
        <div class="alert alert-danger" style="margin-bottom:8px;font-size:13px;">
          <%= testError %>
        </div>
      <% } %>

      <% if (!test) { %>
        <p class="tests-empty">Test topilmadi yoki o'chirilgan.</p>
      <% } else { %>
        <form method="POST" action="/admin/tests/<%= test._id %>/edit" class="form-grid" style="max-width:520px;">
          <div class="form-group">
            <label for="test-title">Test nomi</label>
            <input type="text" id="test-title" name="title" value="<%= test.title %>" />
          </div>
          <div class="form-group">
            <label for="pdfLink">Test PDF (Google Drive) linki</label>
            <input type="url" id="pdfLink" name="pdfLink" value="<%= test.pdfLink %>" />
          </div>
          <div class="form-group">
            <label for="totalQuestions">Umumiy savollar soni</label>
            <input type="number" id="totalQuestions" name="totalQuestions" min="1" value="<%= typeof test.totalQuestions !== 'undefined' && test.totalQuestions !== null ? test.totalQuestions : '' %>" />
          </div>
          <div class="form-group">
            <label for="openCount">Ochiq savollar soni</label>
            <input type="number" id="openCount" name="openCount" min="0" value="<%= typeof test.openCount !== 'undefined' && test.openCount !== null ? test.openCount : 0 %>" />
            <small style="display:block;font-size:12px;color:#56756a;margin-top:4px;">Yopiq savollar soni avtomatik: umumiy - ochiq.</small>
          </div>
          <div class="form-group">
            <label for="timerMinutes">Timer (daqiqalarda, ixtiyoriy)</label>
            <input type="number" id="timerMinutes" name="timerMinutes" min="0" value="<%= typeof test.timerMinutes === 'number' ? test.timerMinutes : '' %>" />
            <small style="display:block;font-size:12px;color:#56756a;margin-top:4px;">Agar bo'sh yoki 0 bo'lsa, bu test uchun timer ishlamaydi.</small>
          </div>
          <div class="form-group">
            <label>
              <input type="checkbox" name="isStarEligible" value="1" <%= test.isStarEligible ? 'checked' : '' %> />
              Bu testni stars uchun hisoblash (yetakchilar bo'yicha mukofot)
            </label>
            <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
              <div style="flex:1;min-width:140px;">
                <label for="starStartDate" style="font-size:12px;color:#275546;display:block;margin-bottom:2px;">Stars uchun boshlanish sana/vaqti (ixtiyoriy)</label>
                <input
                  type="datetime-local"
                  id="starStartDate"
                  name="starStartDate"
                  value="<%= test.starStartDate ? test.starStartDate.toISOString().slice(0,16) : '' %>"
                  style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d5e6df;font-size:13px;"
                />
              </div>
              <div style="flex:1;min-width:140px;">
                <label for="starEndDate" style="font-size:12px;color:#275546;display:block;margin-bottom:2px;">Stars uchun tugash sana/vaqti (ixtiyoriy)</label>
                <input
                  type="datetime-local"
                  id="starEndDate"
                  name="starEndDate"
                  value="<%= test.starEndDate ? test.starEndDate.toISOString().slice(0,16) : '' %>"
                  style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d5e6df;font-size:13px;"
                />
              </div>
            </div>
            <small style="display:block;font-size:12px;color:#56756a;margin-top:4px;">Agar sanalar berilsa, faqat shu oraliqda yechilgan timed testlar uchun stars beriladi.</small>
          </div>
          <div class="form-group">
            <label for="answersText">Javoblar ro'yxati</label>
            <textarea id="answersText" name="answersText" rows="8"><%= test.answersText || '' %></textarea>
            <small style="display:block;font-size:12px;color:#56756a;margin-top:4px;">"N.javob" formatida: 1.A, 2.B, ..., 5.34</small>
          </div>
          <div class="form-group">
            <label for="videoLink">Video (Google Drive) linki (ixtiyoriy)</label>
            <input type="url" id="videoLink" name="videoLink" value="<%= test.videoLink || '' %>" />
          </div>
          <div style="display:flex;gap:8px;margin-top:8px;">
            <a href="/admin#admin-tests" class="btn-outline" style="flex:1;text-align:center;">Bekor qilish</a>
            <button type="submit" class="btn-primary" style="flex:1;">O'zgarishlarni saqlash</button>
          </div>
        </form>
      <% } %>
    </div>
  </section>
</main>

<script>
  (function () {
    var starCheckbox = document.querySelector('input[name="isStarEligible"]');
    var starStartInput = document.getElementById('starStartDate');
    var starEndInput = document.getElementById('starEndDate');

    function updateState() {
      if (!starCheckbox || !starStartInput || !starEndInput) return;
      var enabled = !!starCheckbox.checked;
      starStartInput.disabled = !enabled;
      starEndInput.disabled = !enabled;
      if (!enabled) {
        starStartInput.value = '';
        starEndInput.value = '';
      }
    }

    if (starCheckbox && starStartInput && starEndInput) {
      updateState();
      starCheckbox.addEventListener('change', updateState);
    }
  })();
</script>

<%- include('../partials/footer') %>
