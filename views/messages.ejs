<%- include('partials/head') %>
<%- include('partials/navbar') %>
<main class="page messages-page" data-aos="fade-up">
  <section class="section">
    <div class="section-inner">
      <div class="messages-layout">
        <div class="messages-card">
          <div class="messages-header">
            <div>
              <h1 class="messages-title">Adminga xabar yozish</h1>
              <p class="messages-subtitle">Savollaringizni shu yerda yozib qoldiring, admin sizga shu chat ichida javob beradi.</p>
            </div>
          </div>

          <div class="messages-body" id="userChatBody">
            <div class="messages-empty" id="userChatEmpty">Hozircha xabarlar yo'q. Birinchi bo'lib xabar yozing ðŸ˜Š</div>
          </div>

          <div id="userChatPreview" class="messages-preview messages-preview-hidden">
            <div class="messages-preview-inner">
              <img id="userChatPreviewImage" class="messages-preview-image" alt="Yuklanayotgan rasm" />
              <button type="button" id="userChatPreviewRemove" class="messages-preview-remove">Ã—</button>
            </div>
          </div>

          <form id="userChatForm" class="messages-form">
            <label class="messages-attach-btn">
              <input type="file" id="userChatImage" accept="image/*" hidden />
              <span>ðŸ“Ž</span>
            </label>
            <textarea
              id="userChatInput"
              name="text"
              rows="2"
              placeholder="Xabaringizni yozing..."
            ></textarea>
            <button type="submit" class="btn-primary messages-send-btn">Yuborish</button>
          </form>
        </div>
      </div>
    </div>
  </section>
</main>
<script>
  (function () {
    var chatBody = document.getElementById('userChatBody');
    var chatForm = document.getElementById('userChatForm');
    var chatInput = document.getElementById('userChatInput');
    var chatImageInput = document.getElementById('userChatImage');
    var previewWrap = document.getElementById('userChatPreview');
    var previewImage = document.getElementById('userChatPreviewImage');
    var previewRemove = document.getElementById('userChatPreviewRemove');
    var emptyState = document.getElementById('userChatEmpty');

    function renderMessages(list) {
      if (!chatBody) return;
      chatBody.innerHTML = '';
      if (!list || !list.length) {
        if (emptyState) {
          emptyState.style.display = 'block';
          chatBody.appendChild(emptyState);
        }
        return;
      }

      if (emptyState) {
        emptyState.style.display = 'none';
      }

      list.forEach(function (m) {
        var wrap = document.createElement('div');
        wrap.className = 'messages-item messages-item-' + (m.from === 'user' ? 'self' : 'admin');

        var bubble = document.createElement('div');
        bubble.className = 'messages-bubble';

        var hasText = m.text && String(m.text).trim().length > 0;
        var hasImage = !!m.imageUrl;

        if (hasText) {
          var textNode = document.createElement('div');
          textNode.textContent = m.text;
          bubble.appendChild(textNode);
        }

        if (hasImage) {
          var img = document.createElement('img');
          img.src = m.imageUrl;
          img.className = 'messages-image';
          bubble.appendChild(img);
        }

        wrap.appendChild(bubble);
        chatBody.appendChild(wrap);
      });

      chatBody.scrollTop = chatBody.scrollHeight;
    }

    function loadThread() {
      if (!chatBody) return;
      chatBody.classList.add('messages-body-loading');
      fetch('/messages/api/thread')
        .then(function (res) { return res.json(); })
        .then(function (data) {
          chatBody.classList.remove('messages-body-loading');
          if (!data || !Array.isArray(data.messages)) {
            renderMessages([]);
            return;
          }
          renderMessages(data.messages);
        })
        .catch(function () {
          chatBody.classList.remove('messages-body-loading');
          renderMessages([]);
        });
    }

    function clearPreview() {
      if (previewWrap) {
        previewWrap.classList.add('messages-preview-hidden');
      }
      if (previewImage) {
        previewImage.src = '';
      }
      if (chatImageInput) {
        chatImageInput.value = '';
      }
    }

    if (chatImageInput && previewWrap && previewImage) {
      chatImageInput.addEventListener('change', function () {
        if (!chatImageInput.files || !chatImageInput.files[0]) {
          clearPreview();
          return;
        }
        var file = chatImageInput.files[0];
        var reader = new FileReader();
        reader.onload = function (e) {
          previewImage.src = e.target.result;
          previewWrap.classList.remove('messages-preview-hidden');
        };
        reader.readAsDataURL(file);
      });
    }

    if (previewRemove) {
      previewRemove.addEventListener('click', function () {
        clearPreview();
      });
    }

    function uploadImageIfNeeded() {
      return new Promise(function (resolve) {
        if (!chatImageInput || !chatImageInput.files || !chatImageInput.files[0]) {
          return resolve(null);
        }

        var file = chatImageInput.files[0];
        var formData = new FormData();
        formData.append('image', file);

        fetch('/upload/image', {
          method: 'POST',
          body: formData
        })
          .then(function (res) { return res.json(); })
          .then(function (data) {
            if (data && data.error && !data.url) {
              alert(data.error || 'Rasm yuklashda xato. Iltimos, birozdan so\'ng qayta urinib ko\'ring.');
              clearPreview();
              return resolve(null);
            }
            chatImageInput.value = '';
            if (data && data.url) {
              resolve(data.url);
            } else {
              resolve(null);
            }
          })
          .catch(function () {
            chatImageInput.value = '';
            resolve(null);
          });
      });
    }

    if (chatForm && chatInput) {
      chatForm.addEventListener('submit', function (e) {
        e.preventDefault();
        var text = (chatInput.value || '').trim();
        if (!text && (!chatImageInput || !chatImageInput.files || !chatImageInput.files[0])) return;

        chatForm.classList.add('messages-form-sending');

        uploadImageIfNeeded().then(function (imageUrl) {
          var bodyParts = [];
          if (text) {
            bodyParts.push('text=' + encodeURIComponent(text));
          }
          if (imageUrl) {
            bodyParts.push('imageUrl=' + encodeURIComponent(imageUrl));
          }

          fetch('/messages/api', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
            },
            body: bodyParts.join('&')
          })
            .then(function (res) { return res.json(); })
            .then(function () {
              chatInput.value = '';
              chatForm.classList.remove('messages-form-sending');
              loadThread();
            })
            .catch(function () {
              chatForm.classList.remove('messages-form-sending');
            });
        });
      });
    }

    loadThread();
  })();
</script>
<%- include('partials/footer') %>
